<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="715px" preserveAspectRatio="none" style="width:2328px;height:715px;" version="1.1" viewBox="0 0 2328 715" width="2328px" zoomAndPan="magnify"><defs><filter height="300%" id="f72can5mp9cs8" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="Open Sans" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="1096.75" y="29.9639">Identifying Clients</text><rect fill="#E0FBFC" height="657.707" style="stroke: #9DB4C0; stroke-width: 1.0;" width="883" x="29" y="47.0654"/><text fill="#000000" font-family="Open Sans" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="163" x="389" y="65.9604">Tradeshift.MyApp iframe</text><rect fill="#C2DFE3" height="657.707" style="stroke: #9DB4C0; stroke-width: 1.0;" width="591.5" x="1499" y="47.0654"/><text fill="#000000" font-family="Open Sans" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="186" x="1701.75" y="65.9604">tradeshift-chrome topframe</text><rect fill="#9DB4C0" height="657.707" style="stroke: #9DB4C0; stroke-width: 1.0;" width="168" x="2112.5" y="47.0654"/><text fill="#000000" font-family="Open Sans" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="2139" y="65.9604">Other.App iframe</text><rect fill="#F4FFFF" filter="url(#f72can5mp9cs8)" height="154.8145" style="stroke: #9DB4C0; stroke-width: 1.0;" width="603.5" x="1493" y="345.4854"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="107" x2="107" y1="126.8345" y2="138.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="107" x2="107" y1="138.8345" y2="176.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="107" x2="107" y1="176.8345" y2="604.707"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="107" x2="107" y1="604.707" y2="642.707"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="107" x2="107" y1="642.707" y2="643.707"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="107" x2="107" y1="643.707" y2="653.707"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="509" x2="509" y1="126.8345" y2="138.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="509" x2="509" y1="138.8345" y2="176.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="509" x2="509" y1="176.8345" y2="604.707"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="509" x2="509" y1="604.707" y2="642.707"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="509" x2="509" y1="642.707" y2="643.707"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="509" x2="509" y1="643.707" y2="653.707"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="849" x2="849" y1="126.8345" y2="138.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="849" x2="849" y1="138.8345" y2="176.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="849" x2="849" y1="176.8345" y2="604.707"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="849" x2="849" y1="604.707" y2="642.707"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="849" x2="849" y1="642.707" y2="643.707"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="849" x2="849" y1="643.707" y2="653.707"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="1563" x2="1563" y1="126.8345" y2="138.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1563" x2="1563" y1="138.8345" y2="176.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="1563" x2="1563" y1="176.8345" y2="604.707"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1563" x2="1563" y1="604.707" y2="642.707"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="1563" x2="1563" y1="642.707" y2="643.707"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1563" x2="1563" y1="643.707" y2="653.707"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="2011.5" x2="2011.5" y1="126.8345" y2="138.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2011.5" x2="2011.5" y1="138.8345" y2="176.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="2011.5" x2="2011.5" y1="176.8345" y2="604.707"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2011.5" x2="2011.5" y1="604.707" y2="642.707"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="2011.5" x2="2011.5" y1="642.707" y2="643.707"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2011.5" x2="2011.5" y1="643.707" y2="653.707"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="2196.5" x2="2196.5" y1="126.8345" y2="138.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2196.5" x2="2196.5" y1="138.8345" y2="176.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="2196.5" x2="2196.5" y1="176.8345" y2="604.707"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2196.5" x2="2196.5" y1="604.707" y2="642.707"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="2196.5" x2="2196.5" y1="642.707" y2="643.707"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2196.5" x2="2196.5" y1="643.707" y2="653.707"/><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="144" x="33" y="78.769"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="45" y="105.7329">Tradeshift.MyApp</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="144" x="33" y="652.707"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="45" y="679.6709">Tradeshift.MyApp</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="66" x="474" y="78.769"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="486" y="105.7329">ts.app</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="66" x="474" y="652.707"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="486" y="679.6709">ts.app</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="113" x="791" y="78.769"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="803" y="105.7329">ts.amp.Client</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="113" x="791" y="652.707"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="803" y="679.6709">ts.amp.Client</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="117" x="1503" y="78.769"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1515" y="105.7329">ts.amp.Server</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="117" x="1503" y="652.707"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1515" y="679.6709">ts.amp.Server</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="146" x="1936.5" y="78.769"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="122" x="1948.5" y="105.7329">tradeshift-chrome</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="146" x="1936.5" y="652.707"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="122" x="1948.5" y="679.6709">tradeshift-chrome</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="156" x="2116.5" y="78.769"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="132" x="2128.5" y="105.7329">Other ts.amp.Client</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="156" x="2116.5" y="652.707"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="132" x="2128.5" y="679.6709">Other ts.amp.Client</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="3" x2="2316.5" y1="137.8345" y2="137.8345"/><polygon fill="#E8F6FF" filter="url(#f72can5mp9cs8)" points="792,181.8345,792,218.8345,1620,218.8345,1620,191.8345,1610,181.8345,792,181.8345" style="stroke: #224F6B; stroke-width: 1.0;"/><line style="stroke: #224F6B; stroke-width: 1.0;" x1="1610" x2="1610" y1="181.8345" y2="191.8345"/><line style="stroke: #224F6B; stroke-width: 1.0;" x1="1620" x2="1610" y1="191.8345" y2="191.8345"/><text fill="#1F2D3D" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="378" x="1010.5" y="205.7295">Any incoming request will be followed by an identification check</text><polygon fill="#253237" points="1551.5,325.5381,1561.5,329.5381,1551.5,333.5381,1555.5,329.5381" style="stroke: #253237; stroke-width: 1.0;"/><line style="stroke: #253237; stroke-width: 2.0;" x1="849.5" x2="1557.5" y1="329.5381" y2="329.5381"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="861.5" y="252.1758">CONNECT</text><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="920.5" y="251.4331">/</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="861.5" y="269.8794">PUBLISH</text><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="920.5" y="269.1367">/</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="928.5" y="269.8794">PUBACK</text><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="979.5" y="269.1367">/</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="987.5" y="269.8794">PUBREC</text><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="1038.5" y="269.1367">/</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="1046.5" y="269.8794">PUBCOMP</text><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="1105.5" y="269.1367">/</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="861.5" y="287.583">SUBSCRIBE</text><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="936.5" y="286.8403">/</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="944.5" y="287.583">UNSUBSCRIBE</text><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="1035.5" y="286.8403">/</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="861.5" y="305.2866">PINGREQ</text><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="920.5" y="304.5439">/</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="861.5" y="320.4194">DISCONNECT</text><rect fill="none" height="154.8145" style="stroke: #9DB4C0; stroke-width: 1.0;" width="603.5" x="1493" y="345.4854"/><polygon fill="#EAFFFF" points="1493,345.4854,1599,345.4854,1599,364.4854,1589,374.4854,1493,374.4854,1493,345.4854" style="stroke: #9DB4C0; stroke-width: 1.0;"/><text fill="#000000" font-family="Open Sans" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="51" x="1513" y="365.3804">Identify</text><polygon fill="#253237" points="1999.5,404.189,2009.5,408.189,1999.5,412.189,2003.5,408.189" style="stroke: #253237; stroke-width: 1.0;"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="2005.5" y1="408.189" y2="408.189"/><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1575.5" y="398.084">Identify</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="1624.5" y="398.8267">clientId</text><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="1691.5" y="398.084">based on</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="1749.5" y="398.8267">postMessage</text><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="1840.5" y="398.084">origin</text><polygon fill="#253237" points="1574.5,418.8926,1564.5,422.8926,1574.5,426.8926,1570.5,422.8926" style="stroke: #253237; stroke-width: 1.0;"/><line style="stroke: #253237; stroke-width: 2.0; stroke-dasharray: 2.0,2.0;" x1="1568.5" x2="2010.5" y1="422.8926" y2="422.8926"/><polygon fill="#E8F6FF" filter="url(#f72can5mp9cs8)" points="1568,435.8926,1568,490.8926,1902,490.8926,1902,445.8926,1892,435.8926,1568,435.8926" style="stroke: #224F6B; stroke-width: 1.0;"/><line style="stroke: #224F6B; stroke-width: 1.0;" x1="1892" x2="1892" y1="435.8926" y2="445.8926"/><line style="stroke: #224F6B; stroke-width: 1.0;" x1="1902" x2="1892" y1="445.8926" y2="445.8926"/><text fill="#1F2D3D" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="1579" y="459.7876">If message sender can't be identified or recognized,</text><text fill="#1F2D3D" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="1579" y="477.4912">the message is ignored</text><polygon fill="#E8F6FF" filter="url(#f72can5mp9cs8)" points="1405,512.2998,1405,549.2998,1717,549.2998,1717,522.2998,1707,512.2998,1405,512.2998" style="stroke: #224F6B; stroke-width: 1.0;"/><line style="stroke: #224F6B; stroke-width: 1.0;" x1="1707" x2="1707" y1="512.2998" y2="522.2998"/><line style="stroke: #224F6B; stroke-width: 1.0;" x1="1717" x2="1707" y1="522.2998" y2="522.2998"/><text fill="#1F2D3D" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="1416" y="536.1948">From now on this step will be shown as follows:</text><polygon fill="#E8F6FF" filter="url(#f72can5mp9cs8)" points="1515,564.0034,1612,564.0034,1622,581.0034,1612,599.0034,1515,599.0034,1505,581.0034,1515,564.0034" style="stroke: #224F6B; stroke-width: 1.0;"/><text fill="#1F2D3D" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1522" y="586.8984">Identify Client</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="3" x2="2316.5" y1="642.707" y2="642.707"/><!--
@startuml

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		BoxBorderColor #9DB4C0
		Group {
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

title Connecting - ""ts.app.connect()""

...

"Tradeshift.MyApp" -> "ts.app": ""ts.app.connect()""
create "ts.amp.Client"
"ts.app" -> "ts.amp.Client": Create internal ""ts.amp.Client"" instance
"ts.amp.Client" -> "ts.amp.Server": ""CONNECT""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Client" <- - "ts.amp.Server": ""CONNACK(returnCode=0)""
"ts.amp.Server" ->> "ts.amp.Server": ""ts.amp.Server#subscribe(ts.amp.Subscription)""
note right of "ts.amp.Server": Subscribe Client to ""+/+/VendorId/AppId/#""\nOnly start publishing to Client after ""CONNACK"" was sent

...

newpage Identifying Clients

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

note over "ts.amp.Client", "ts.amp.Server": Any incoming request will be followed by an identification check
"ts.amp.Client" -> "ts.amp.Server": ""CONNECT"" /\n""PUBLISH"" / ""PUBACK"" / ""PUBREC"" / ""PUBCOMP"" /\n""SUBSCRIBE"" / ""UNSUBSCRIBE"" /\n""PINGREQ"" /\n""DISCONNECT""
group Identify
	"ts.amp.Server" -> "tradeshift-chrome": Identify ""clientId"" based on ""postMessage"" origin
	"ts.amp.Server" <- - "tradeshift-chrome"
	note right of "ts.amp.Server": If message sender can't be identified or recognized,\nthe message is ignored
end
note over "ts.amp.Server": From now on this step will be shown as follows:
hnote over "ts.amp.Server": Identify Client

...

newpage Keeping Connection Alive

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

loop Within ""keepAlive"" seconds if no other messages are sent
		"ts.amp.Client" ->> "ts.amp.Server": ""PINGREQ""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Client" <<- - "ts.amp.Server": ""PINGRES""
	end

...

newpage Publishing - ""ts.app.publish()""

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

"Tradeshift.MyApp" ->> "ts.app": ""ts.app.publish(ts.app.Message)""
"ts.app" ->> "ts.amp.Client"
alt QoS Level 0
	"ts.amp.Client" ->> "ts.amp.Server": ""PUBLISH("topic", payload, QoS=0)""
	hnote over "ts.amp.Server": Identify Client
else QoS Level 1
	"ts.amp.Client" ->> "ts.amp.Server": ""PUBLISH("topic", payload, QoS=1)""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" ->> "ts.amp.Server": Persist message
	"ts.amp.Client" <<- - "ts.amp.Server": ""PUBACK""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Client" ->> "ts.amp.Client": Delete message
else QoS Level 2
	"ts.amp.Client" ->> "ts.amp.Server": ""PUBLISH("topic", payload, QoS=2)""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" ->> "ts.amp.Server": Persist message
	"ts.amp.Client" <<- - "ts.amp.Server": ""PUBREC""
	"ts.amp.Client" ->> "ts.amp.Server": ""PUBREL""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Client" <<- - "ts.amp.Server": ""PUBCOMP""
	"ts.amp.Client" ->> "ts.amp.Client": Delete message
end
loop For each client subscribed to "topic"
	alt QoS Level 0
		"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("topic", payload, QoS=0)""
	else QoS Level 1
		"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("topic", payload, QoS=1)""
		"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBACK""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Server" ->> "ts.amp.Server": Delete message
	else QoS Level 2
		"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("topic", payload, QoS=2)""
		"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBREC""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBREL"
		"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBCOMP""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Server" ->> "ts.amp.Server": Delete message
	end
end

...

newpage Listening - ""ts.app.listen()""

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

alt QoS Level 0
	"ts.amp.Server" <<- "Other ts.amp.Client": ""PUBLISH("topic", payload, Qos=0)""
	hnote over "ts.amp.Server": Identify Client
else QoS Level 1
	"ts.amp.Server" <<- "Other ts.amp.Client": ""PUBLISH("topic", payload, Qos=1)""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" - ->> "Other ts.amp.Client": ""PUBACK""
	"ts.amp.Server" ->> "ts.amp.Server": Delete message
else QoS Level 2
	"ts.amp.Server" <<- "Other ts.amp.Client": ""PUBLISH("topic", payload, Qos=2)""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" - ->> "Other ts.amp.Client": ""PUBREC""
	"ts.amp.Server" <<- "Other ts.amp.Client": ""PUBREL""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" - ->> "Other ts.amp.Client": ""PUBCOMP""
	"ts.amp.Server" ->> "ts.amp.Server": Delete message
end
loop For each client subscribed to "topic"
	alt QoS Level 0
		"ts.amp.Client" <<- "ts.amp.Server": ""PUBLISH("topic", payload, Qos=0)""
		"ts.app" <<- "ts.amp.Client" : ""ts.app.listen(ts.app.MessageHandler)""
		"Tradeshift.MyApp" <- "ts.app" : ""messageHandler""
	else QoS Level 1
		"ts.amp.Client" <<- "ts.amp.Server": ""PUBLISH("topic", payload, Qos=1)""
		"ts.amp.Client" - ->> "ts.amp.Server": ""PUBACK""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Server" ->> "ts.amp.Server": Delete message
		"ts.app" <<- "ts.amp.Client" : ""ts.app.listen(ts.app.MessageHandler)""
		"Tradeshift.MyApp" <- "ts.app" : ""messageHandler""
	else QoS Level 2
		"ts.amp.Client" <<- "ts.amp.Server": ""PUBLISH("topic", payload, Qos=2)""
		"ts.amp.Client" - ->> "ts.amp.Server": ""PUBREC""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Client" <<- "ts.amp.Server": ""PUBREL""
		"ts.amp.Client" - ->> "ts.amp.Server": ""PUBCOMP""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Server" ->> "ts.amp.Server": Delete message
		"ts.app" <<- "ts.amp.Client" : ""ts.app.listen(ts.app.MessageHandler)""
		"Tradeshift.MyApp" <- "ts.app" : ""messageHandler""
	end
end

...

newpage Subscribing - ""ts.app.subscribe()""

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

"Tradeshift.MyApp" ->> "ts.app": ""ts.app.subscribe(Array<ts.app.Subscription>)""
activate "ts.app"
"ts.app" ->> "ts.amp.Client"
"ts.amp.Client" ->> "ts.amp.Server": ""SUBSCRIBE({"topic0", QoS=0}, {"topic1", QoS=1}, {"topic2", QoS=2}, {"topic3", QoS=1})""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Server" ->> "ts.amp.Server": ""ts.amp.Server.unsubscribe(Array<ts.amp.Subscription>)""
"ts.amp.Client" <<- - "ts.amp.Server": ""SUBACK(0, 1, 2, 128)""
note right of "ts.amp.Server": Server will forward the messages for requested subscription after sending ""SUBACK""\nSee @Receiving
deactivate "ts.app"

...

newpage Unsubscribing - ""ts.app.unsubscribe()""

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

"Tradeshift.MyApp" ->> "ts.app": ""ts.app.unsubscribe(Array<ts.app.Subscription>)""
activate "ts.app"
"ts.app" ->> "ts.amp.Client"
"ts.amp.Client" ->> "ts.amp.Server": ""UNSUBSCRIBE("topic0", "topic1", "topic2)""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Server" ->> "ts.amp.Server": ""ts.amp.Server.subscribe(Array<ts.amp.Subscription>)""
"ts.amp.Client" <<- - "ts.amp.Server": ""UNSUBACK""
note right of "ts.amp.Server": Server will not forward any more messages for this subscription after sending ""UNSUBACK""\nIt does finish sending any messages that were in progress(QoS1, QoS2)
deactivate "ts.app"

...

newpage Exchange - ""ts.app.exchange()"" / Load - ""ts.app.load()""

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

"ts.app" ->> "ts.amp.Client": ""ts.app.exchange(ts.app.Message)""
activate "ts.app"
"ts.amp.Client" ->> "ts.amp.Server": ""SUBSCRIBE("exchange topic", QoS=1, retain=false)""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Server" ->> "ts.amp.Server": ""ts.amp.Server.subscribe(Array<ts.amp.Subscription>)""
"ts.amp.Client" <<- - "ts.amp.Server": ""SUBACK(1)""
"ts.amp.Client" ->> "ts.amp.Server": ""PUBLISH("exchange topic", payload={request}, QoS=1, retain=false)""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Client" <<- - "ts.amp.Server": ""PUBACK""
"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("exchange topic", payload={request}, QoS=1, retain=false)""
"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBACK""
hnote over "ts.amp.Server": Identify Client
alt Success, other app is listening and responding
	"ts.amp.Server" <<- "Other ts.amp.Client": ""PUBLISH("exchange topic", payload={loading: true}, QoS=1, retain=false)""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" - ->> "Other ts.amp.Client": ""PUBACK""
	loop While we're waiting for user interaction to finish
		"ts.amp.Server" <<- "Other ts.amp.Client": ""PINGREQ""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Server" - ->> "Other ts.amp.Client": ""PINGRES""
		"ts.amp.Client" ->> "ts.amp.Server": ""PINGREQ""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Client" <<- - "ts.amp.Server": ""PINGRES""
	end
	"ts.amp.Server" <<- "Other ts.amp.Client": ""PUBLISH("exchange topic", payload={response}, QoS=1, retain=false)""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" - ->> "Other ts.amp.Client": ""PUBACK""
	"ts.amp.Client" <<- "ts.amp.Server": ""PUBLISH("exchange topic", payload={response}, QoS=1, retain=false)""
	"ts.amp.Client" - ->> "ts.amp.Server": ""PUBACK""
	hnote over "ts.amp.Server": Identify Client
else Failure, other app is not listening or responding
	note over "ts.amp.Server":No meaningful response from other app within ""keepAlive"" seconds
	"ts.amp.Client" <<- "ts.amp.Server": ""PUBLISH("exchange topic", payload={err}, QoS=1, retain=false)""
	"ts.amp.Client" - ->> "ts.amp.Server": ""PUBACK""
	hnote over "ts.amp.Server": Identify Client
end
deactivate "ts.app"
"ts.amp.Client" ->> "ts.amp.Server": ""UNSUBSCRIBE("exchange topic")""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Server" ->> "ts.amp.Server": ""ts.amp.Server.unsubscribe(Array<ts.amp.Subscription>)""
"ts.amp.Client" <<- - "ts.amp.Server": ""UNSUBACK""

...

newpage Unexpected disconnect

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...
note over "ts.amp.Client": No messages sent for ""keepAlive"" seconds
"ts.amp.Server" -> "ts.amp.Server": ts.amp.Server.unsubscribe()
note right of "ts.amp.Server": Unsubscribe Client from all of its subscriptions

opt If ""ts.amp.Client"" has a ""will"" defined
	loop For each client subscribed to "will topic"
		alt QoS Level 0
			"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("will topic", payload, QoS=0)""
		else QoS Level 1
			"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("will topic", payload, QoS=1)""
			"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBACK""
			hnote over "ts.amp.Server": Identify Client
			"ts.amp.Server" ->> "ts.amp.Server": Delete message
		else QoS Level 2
			"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("will topic", payload, QoS=2)""
			"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBREC""
			hnote over "ts.amp.Server": Identify Client
			"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBREL"
			"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBCOMP""
			hnote over "ts.amp.Server": Identify Client
			"ts.amp.Server" ->> "ts.amp.Server": Delete message
		end
	end
end

...

newpage Disconnecting - ""ts.app.disconnect()""

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		BoxBorderColor #9DB4C0
		Group {
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

[-> "ts.app": ts.app.disconnect()
"ts.app" -> "ts.amp.Client"
"ts.amp.Client" -> "ts.amp.Server": ""DISCONNECT""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Server" -> "ts.amp.Server": ts.amp.Server.unsubscribe()
note right of "ts.amp.Server": Unsubscribe Client from all of its subscriptions

@enduml

PlantUML version 1.2017.15(Mon Jul 03 18:45:34 CEST 2017)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1024-b8
Operating System: Mac OS X
OS Version: 10.13.2
Default Encoding: UTF-8
Language: en
Country: DK
--></g></svg>