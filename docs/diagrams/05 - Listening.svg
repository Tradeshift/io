<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1887px" preserveAspectRatio="none" style="width:2328px;height:1887px;" version="1.1" viewBox="0 0 2328 1887" width="2328px" zoomAndPan="magnify"><defs><filter height="300%" id="f72can5mp9cs8" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="Open Sans" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1061.75" y="29.9639">Listening -</text><text fill="#000000" font-family="monospace" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="1137.75" y="30.7637">ts.app.listen()</text><rect fill="#E0FBFC" height="1829.7339" style="stroke: #9DB4C0; stroke-width: 1.0;" width="883" x="29" y="47.0654"/><text fill="#000000" font-family="Open Sans" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="163" x="389" y="65.9604">Tradeshift.MyApp iframe</text><rect fill="#C2DFE3" height="1829.7339" style="stroke: #9DB4C0; stroke-width: 1.0;" width="591.5" x="1499" y="47.0654"/><text fill="#000000" font-family="Open Sans" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="186" x="1701.75" y="65.9604">tradeshift-chrome topframe</text><rect fill="#9DB4C0" height="1829.7339" style="stroke: #9DB4C0; stroke-width: 1.0;" width="168" x="2112.5" y="47.0654"/><text fill="#000000" font-family="Open Sans" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="2139" y="65.9604">Other.App iframe</text><rect fill="#F4FFFF" filter="url(#f72can5mp9cs8)" height="663.8804" style="stroke: #9DB4C0; stroke-width: 1.0;" width="793.5" x="1493" y="183.8345"/><rect fill="#F4FFFF" height="207.0146" style="stroke: none; stroke-width: 1.0;" width="793.5" x="1493" y="309.7163"/><rect fill="#F4FFFF" height="330.9839" style="stroke: none; stroke-width: 1.0;" width="793.5" x="1493" y="516.731"/><rect fill="#F4FFFF" filter="url(#f72can5mp9cs8)" height="908.019" style="stroke: #9DB4C0; stroke-width: 1.0;" width="1682.5" x="13" y="861.7148"/><rect fill="#F4FFFF" filter="url(#f72can5mp9cs8)" height="852.9736" style="stroke: #9DB4C0; stroke-width: 1.0;" width="1662.5" x="23" y="909.7603"/><rect fill="#F4FFFF" height="285.2803" style="stroke: none; stroke-width: 1.0;" width="1662.5" x="23" y="1068.2041"/><rect fill="#F4FFFF" height="409.2495" style="stroke: none; stroke-width: 1.0;" width="1662.5" x="23" y="1353.4844"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="107" x2="107" y1="126.8345" y2="138.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="107" x2="107" y1="138.8345" y2="176.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="107" x2="107" y1="176.8345" y2="1776.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="107" x2="107" y1="1776.7339" y2="1814.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="107" x2="107" y1="1814.7339" y2="1815.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="107" x2="107" y1="1815.7339" y2="1825.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="509" x2="509" y1="126.8345" y2="138.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="509" x2="509" y1="138.8345" y2="176.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="509" x2="509" y1="176.8345" y2="1776.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="509" x2="509" y1="1776.7339" y2="1814.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="509" x2="509" y1="1814.7339" y2="1815.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="509" x2="509" y1="1815.7339" y2="1825.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="849" x2="849" y1="126.8345" y2="138.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="849" x2="849" y1="138.8345" y2="176.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="849" x2="849" y1="176.8345" y2="1776.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="849" x2="849" y1="1776.7339" y2="1814.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="849" x2="849" y1="1814.7339" y2="1815.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="849" x2="849" y1="1815.7339" y2="1825.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="1563" x2="1563" y1="126.8345" y2="138.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1563" x2="1563" y1="138.8345" y2="176.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="1563" x2="1563" y1="176.8345" y2="1776.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1563" x2="1563" y1="1776.7339" y2="1814.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="1563" x2="1563" y1="1814.7339" y2="1815.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1563" x2="1563" y1="1815.7339" y2="1825.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="2011.5" x2="2011.5" y1="126.8345" y2="138.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2011.5" x2="2011.5" y1="138.8345" y2="176.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="2011.5" x2="2011.5" y1="176.8345" y2="1776.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2011.5" x2="2011.5" y1="1776.7339" y2="1814.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="2011.5" x2="2011.5" y1="1814.7339" y2="1815.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2011.5" x2="2011.5" y1="1815.7339" y2="1825.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="2196.5" x2="2196.5" y1="126.8345" y2="138.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2196.5" x2="2196.5" y1="138.8345" y2="176.8345"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="2196.5" x2="2196.5" y1="176.8345" y2="1776.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2196.5" x2="2196.5" y1="1776.7339" y2="1814.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0;" x1="2196.5" x2="2196.5" y1="1814.7339" y2="1815.7339"/><line style="stroke: #5C6B73; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2196.5" x2="2196.5" y1="1815.7339" y2="1825.7339"/><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="144" x="33" y="78.769"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="45" y="105.7329">Tradeshift.MyApp</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="144" x="33" y="1824.7339"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="45" y="1851.6978">Tradeshift.MyApp</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="66" x="474" y="78.769"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="486" y="105.7329">ts.app</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="66" x="474" y="1824.7339"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="486" y="1851.6978">ts.app</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="113" x="791" y="78.769"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="803" y="105.7329">ts.amp.Client</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="113" x="791" y="1824.7339"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="803" y="1851.6978">ts.amp.Client</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="117" x="1503" y="78.769"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1515" y="105.7329">ts.amp.Server</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="117" x="1503" y="1824.7339"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1515" y="1851.6978">ts.amp.Server</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="146" x="1936.5" y="78.769"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="122" x="1948.5" y="105.7329">tradeshift-chrome</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="146" x="1936.5" y="1824.7339"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="122" x="1948.5" y="1851.6978">tradeshift-chrome</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="156" x="2116.5" y="78.769"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="132" x="2128.5" y="105.7329">Other ts.amp.Client</text><rect fill="#5C6B73" filter="url(#f72can5mp9cs8)" height="43.0654" style="stroke: #5C6B73; stroke-width: 1.5;" width="156" x="2116.5" y="1824.7339"/><text fill="#FFFFFF" font-family="Open Sans" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="132" x="2128.5" y="1851.6978">Other ts.amp.Client</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="3" x2="2316.5" y1="137.8345" y2="137.8345"/><rect fill="none" height="663.8804" style="stroke: #9DB4C0; stroke-width: 1.0;" width="793.5" x="1493" y="183.8345"/><polygon fill="#EAFFFF" points="1493,183.8345,1566,183.8345,1566,202.8345,1556,212.8345,1493,212.8345,1493,183.8345" style="stroke: #9DB4C0; stroke-width: 1.0;"/><text fill="#000000" font-family="Open Sans" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1513" y="203.7295">alt</text><text fill="#000000" font-family="Open Sans" font-size="12" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="1586" y="203.6606">[QoS Level 0]</text><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="1573.5" y1="255.8799" y2="251.8799"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="1573.5" y1="255.8799" y2="259.8799"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="2195.5" y1="255.8799" y2="255.8799"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="1585.5" y="245.9468">PUBLISH("topic", payload, Qos=0)</text><polygon fill="#E8F6FF" filter="url(#f72can5mp9cs8)" points="1515,269.0127,1612,269.0127,1622,286.0127,1612,304.0127,1515,304.0127,1505,286.0127,1515,269.0127" style="stroke: #224F6B; stroke-width: 1.0;"/><text fill="#1F2D3D" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1522" y="291.9077">Identify Client</text><line style="stroke: #9DB4C0; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1493" x2="2286.5" y1="310.7163" y2="310.7163"/><text fill="#000000" font-family="Open Sans" font-size="12" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="1503" y="328.5425">[QoS Level 1]</text><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="1573.5" y1="369.0581" y2="365.0581"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="1573.5" y1="369.0581" y2="373.0581"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="2195.5" y1="369.0581" y2="369.0581"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="1585.5" y="359.125">PUBLISH("topic", payload, Qos=1)</text><polygon fill="#E8F6FF" filter="url(#f72can5mp9cs8)" points="1515,382.1909,1612,382.1909,1622,399.1909,1612,417.1909,1515,417.1909,1505,399.1909,1515,382.1909" style="stroke: #224F6B; stroke-width: 1.0;"/><text fill="#1F2D3D" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1522" y="405.0859">Identify Client</text><line style="stroke: #253237; stroke-width: 2.0;" x1="2194.5" x2="2184.5" y1="453.8945" y2="449.8945"/><line style="stroke: #253237; stroke-width: 2.0;" x1="2194.5" x2="2184.5" y1="453.8945" y2="457.8945"/><line style="stroke: #253237; stroke-width: 2.0; stroke-dasharray: 2.0,2.0;" x1="1563.5" x2="2195.5" y1="453.8945" y2="453.8945"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="1575.5" y="443.9614">PUBACK</text><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="1605.5" y1="495.731" y2="495.731"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1605.5" x2="1605.5" y1="495.731" y2="508.731"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1564.5" x2="1605.5" y1="508.731" y2="508.731"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1564.5" x2="1574.5" y1="508.731" y2="504.731"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1564.5" x2="1574.5" y1="508.731" y2="512.731"/><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1575.5" y="484.9224">Delete message</text><line style="stroke: #9DB4C0; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1493" x2="2286.5" y1="517.731" y2="517.731"/><text fill="#000000" font-family="Open Sans" font-size="12" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="1503" y="535.5571">[QoS Level 2]</text><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="1573.5" y1="576.0728" y2="572.0728"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="1573.5" y1="576.0728" y2="580.0728"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="2195.5" y1="576.0728" y2="576.0728"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="1585.5" y="566.1396">PUBLISH("topic", payload, Qos=2)</text><polygon fill="#E8F6FF" filter="url(#f72can5mp9cs8)" points="1515,589.2056,1612,589.2056,1622,606.2056,1612,624.2056,1515,624.2056,1505,606.2056,1515,589.2056" style="stroke: #224F6B; stroke-width: 1.0;"/><text fill="#1F2D3D" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1522" y="612.1006">Identify Client</text><line style="stroke: #253237; stroke-width: 2.0;" x1="2194.5" x2="2184.5" y1="660.9092" y2="656.9092"/><line style="stroke: #253237; stroke-width: 2.0;" x1="2194.5" x2="2184.5" y1="660.9092" y2="664.9092"/><line style="stroke: #253237; stroke-width: 2.0; stroke-dasharray: 2.0,2.0;" x1="1563.5" x2="2195.5" y1="660.9092" y2="660.9092"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="1575.5" y="650.9761">PUBREC</text><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="1573.5" y1="700.042" y2="696.042"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="1573.5" y1="700.042" y2="704.042"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="2195.5" y1="700.042" y2="700.042"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="1585.5" y="690.1089">PUBREL</text><polygon fill="#E8F6FF" filter="url(#f72can5mp9cs8)" points="1515,713.1748,1612,713.1748,1622,730.1748,1612,748.1748,1515,748.1748,1505,730.1748,1515,713.1748" style="stroke: #224F6B; stroke-width: 1.0;"/><text fill="#1F2D3D" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1522" y="736.0698">Identify Client</text><line style="stroke: #253237; stroke-width: 2.0;" x1="2194.5" x2="2184.5" y1="784.8784" y2="780.8784"/><line style="stroke: #253237; stroke-width: 2.0;" x1="2194.5" x2="2184.5" y1="784.8784" y2="788.8784"/><line style="stroke: #253237; stroke-width: 2.0; stroke-dasharray: 2.0,2.0;" x1="1563.5" x2="2195.5" y1="784.8784" y2="784.8784"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="1575.5" y="774.9453">PUBCOMP</text><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="1605.5" y1="826.7148" y2="826.7148"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1605.5" x2="1605.5" y1="826.7148" y2="839.7148"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1564.5" x2="1605.5" y1="839.7148" y2="839.7148"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1564.5" x2="1574.5" y1="839.7148" y2="835.7148"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1564.5" x2="1574.5" y1="839.7148" y2="843.7148"/><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1575.5" y="815.9063">Delete message</text><rect fill="none" height="908.019" style="stroke: #9DB4C0; stroke-width: 1.0;" width="1682.5" x="13" y="861.7148"/><polygon fill="#EAFFFF" points="13,861.7148,96,861.7148,96,880.7148,86,890.7148,13,890.7148,13,861.7148" style="stroke: #9DB4C0; stroke-width: 1.0;"/><text fill="#000000" font-family="Open Sans" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="33" y="881.6099">loop</text><text fill="#000000" font-family="Open Sans" font-size="12" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="116" y="881.541">[For each client subscribed to "topic"]</text><rect fill="none" height="852.9736" style="stroke: #9DB4C0; stroke-width: 1.0;" width="1662.5" x="23" y="909.7603"/><polygon fill="#EAFFFF" points="23,909.7603,96,909.7603,96,928.7603,86,938.7603,23,938.7603,23,909.7603" style="stroke: #9DB4C0; stroke-width: 1.0;"/><text fill="#000000" font-family="Open Sans" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="43" y="929.6553">alt</text><text fill="#000000" font-family="Open Sans" font-size="12" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="116" y="929.5864">[QoS Level 0]</text><line style="stroke: #253237; stroke-width: 2.0;" x1="849.5" x2="859.5" y1="981.8057" y2="977.8057"/><line style="stroke: #253237; stroke-width: 2.0;" x1="849.5" x2="859.5" y1="981.8057" y2="985.8057"/><line style="stroke: #253237; stroke-width: 2.0;" x1="849.5" x2="1562.5" y1="981.8057" y2="981.8057"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="871.5" y="971.8726">PUBLISH("topic", payload, Qos=0)</text><line style="stroke: #253237; stroke-width: 2.0;" x1="509" x2="519" y1="1020.9385" y2="1016.9385"/><line style="stroke: #253237; stroke-width: 2.0;" x1="509" x2="519" y1="1020.9385" y2="1024.9385"/><line style="stroke: #253237; stroke-width: 2.0;" x1="509" x2="848.5" y1="1020.9385" y2="1020.9385"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="531" y="1011.0054">ts.app.listen(ts.app.MessageHandler)</text><polygon fill="#253237" points="118,1056.0713,108,1060.0713,118,1064.0713,114,1060.0713" style="stroke: #253237; stroke-width: 1.0;"/><line style="stroke: #253237; stroke-width: 2.0;" x1="112" x2="508" y1="1060.0713" y2="1060.0713"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="129" y="1050.1382">messageHandler</text><line style="stroke: #9DB4C0; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1685.5" y1="1069.2041" y2="1069.2041"/><text fill="#000000" font-family="Open Sans" font-size="12" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="33" y="1087.0303">[QoS Level 1]</text><line style="stroke: #253237; stroke-width: 2.0;" x1="849.5" x2="859.5" y1="1127.5459" y2="1123.5459"/><line style="stroke: #253237; stroke-width: 2.0;" x1="849.5" x2="859.5" y1="1127.5459" y2="1131.5459"/><line style="stroke: #253237; stroke-width: 2.0;" x1="849.5" x2="1562.5" y1="1127.5459" y2="1127.5459"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="871.5" y="1117.6128">PUBLISH("topic", payload, Qos=1)</text><line style="stroke: #253237; stroke-width: 2.0;" x1="1561.5" x2="1551.5" y1="1166.6787" y2="1162.6787"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1561.5" x2="1551.5" y1="1166.6787" y2="1170.6787"/><line style="stroke: #253237; stroke-width: 2.0; stroke-dasharray: 2.0,2.0;" x1="849.5" x2="1562.5" y1="1166.6787" y2="1166.6787"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="861.5" y="1156.7456">PUBACK</text><polygon fill="#E8F6FF" filter="url(#f72can5mp9cs8)" points="1515,1179.8115,1612,1179.8115,1622,1196.8115,1612,1214.8115,1515,1214.8115,1505,1196.8115,1515,1179.8115" style="stroke: #224F6B; stroke-width: 1.0;"/><text fill="#1F2D3D" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1522" y="1202.7065">Identify Client</text><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="1605.5" y1="1254.2188" y2="1254.2188"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1605.5" x2="1605.5" y1="1254.2188" y2="1267.2188"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1564.5" x2="1605.5" y1="1267.2188" y2="1267.2188"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1564.5" x2="1574.5" y1="1267.2188" y2="1263.2188"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1564.5" x2="1574.5" y1="1267.2188" y2="1271.2188"/><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1575.5" y="1243.4102">Delete message</text><line style="stroke: #253237; stroke-width: 2.0;" x1="509" x2="519" y1="1306.2188" y2="1302.2188"/><line style="stroke: #253237; stroke-width: 2.0;" x1="509" x2="519" y1="1306.2188" y2="1310.2188"/><line style="stroke: #253237; stroke-width: 2.0;" x1="509" x2="848.5" y1="1306.2188" y2="1306.2188"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="531" y="1296.2856">ts.app.listen(ts.app.MessageHandler)</text><polygon fill="#253237" points="118,1341.3516,108,1345.3516,118,1349.3516,114,1345.3516" style="stroke: #253237; stroke-width: 1.0;"/><line style="stroke: #253237; stroke-width: 2.0;" x1="112" x2="508" y1="1345.3516" y2="1345.3516"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="129" y="1335.4185">messageHandler</text><line style="stroke: #9DB4C0; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1685.5" y1="1354.4844" y2="1354.4844"/><text fill="#000000" font-family="Open Sans" font-size="12" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="33" y="1372.3105">[QoS Level 2]</text><line style="stroke: #253237; stroke-width: 2.0;" x1="849.5" x2="859.5" y1="1412.8262" y2="1408.8262"/><line style="stroke: #253237; stroke-width: 2.0;" x1="849.5" x2="859.5" y1="1412.8262" y2="1416.8262"/><line style="stroke: #253237; stroke-width: 2.0;" x1="849.5" x2="1562.5" y1="1412.8262" y2="1412.8262"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="871.5" y="1402.8931">PUBLISH("topic", payload, Qos=2)</text><line style="stroke: #253237; stroke-width: 2.0;" x1="1561.5" x2="1551.5" y1="1451.959" y2="1447.959"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1561.5" x2="1551.5" y1="1451.959" y2="1455.959"/><line style="stroke: #253237; stroke-width: 2.0; stroke-dasharray: 2.0,2.0;" x1="849.5" x2="1562.5" y1="1451.959" y2="1451.959"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="861.5" y="1442.0259">PUBREC</text><polygon fill="#E8F6FF" filter="url(#f72can5mp9cs8)" points="1515,1465.0918,1612,1465.0918,1622,1482.0918,1612,1500.0918,1515,1500.0918,1505,1482.0918,1515,1465.0918" style="stroke: #224F6B; stroke-width: 1.0;"/><text fill="#1F2D3D" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1522" y="1487.9868">Identify Client</text><line style="stroke: #253237; stroke-width: 2.0;" x1="849.5" x2="859.5" y1="1536.7954" y2="1532.7954"/><line style="stroke: #253237; stroke-width: 2.0;" x1="849.5" x2="859.5" y1="1536.7954" y2="1540.7954"/><line style="stroke: #253237; stroke-width: 2.0;" x1="849.5" x2="1562.5" y1="1536.7954" y2="1536.7954"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="871.5" y="1526.8623">PUBREL</text><line style="stroke: #253237; stroke-width: 2.0;" x1="1561.5" x2="1551.5" y1="1575.9282" y2="1571.9282"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1561.5" x2="1551.5" y1="1575.9282" y2="1579.9282"/><line style="stroke: #253237; stroke-width: 2.0; stroke-dasharray: 2.0,2.0;" x1="849.5" x2="1562.5" y1="1575.9282" y2="1575.9282"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="861.5" y="1565.9951">PUBCOMP</text><polygon fill="#E8F6FF" filter="url(#f72can5mp9cs8)" points="1515,1589.061,1612,1589.061,1622,1606.061,1612,1624.061,1515,1624.061,1505,1606.061,1515,1589.061" style="stroke: #224F6B; stroke-width: 1.0;"/><text fill="#1F2D3D" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1522" y="1611.9561">Identify Client</text><line style="stroke: #253237; stroke-width: 2.0;" x1="1563.5" x2="1605.5" y1="1663.4683" y2="1663.4683"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1605.5" x2="1605.5" y1="1663.4683" y2="1676.4683"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1564.5" x2="1605.5" y1="1676.4683" y2="1676.4683"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1564.5" x2="1574.5" y1="1676.4683" y2="1672.4683"/><line style="stroke: #253237; stroke-width: 2.0;" x1="1564.5" x2="1574.5" y1="1676.4683" y2="1680.4683"/><text fill="#000000" font-family="Open Sans" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1575.5" y="1652.6597">Delete message</text><line style="stroke: #253237; stroke-width: 2.0;" x1="509" x2="519" y1="1715.4683" y2="1711.4683"/><line style="stroke: #253237; stroke-width: 2.0;" x1="509" x2="519" y1="1715.4683" y2="1719.4683"/><line style="stroke: #253237; stroke-width: 2.0;" x1="509" x2="848.5" y1="1715.4683" y2="1715.4683"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="531" y="1705.5352">ts.app.listen(ts.app.MessageHandler)</text><polygon fill="#253237" points="118,1750.6011,108,1754.6011,118,1758.6011,114,1754.6011" style="stroke: #253237; stroke-width: 1.0;"/><line style="stroke: #253237; stroke-width: 2.0;" x1="112" x2="508" y1="1754.6011" y2="1754.6011"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="129" y="1744.668">messageHandler</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="3" x2="2316.5" y1="1814.7339" y2="1814.7339"/><!--
@startuml

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		BoxBorderColor #9DB4C0
		Group {
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

title Connecting - ""ts.app.connect()""

...

"Tradeshift.MyApp" -> "ts.app": ""ts.app.connect()""
create "ts.amp.Client"
"ts.app" -> "ts.amp.Client": Create internal ""ts.amp.Client"" instance
"ts.amp.Client" -> "ts.amp.Server": ""CONNECT""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Client" <- - "ts.amp.Server": ""CONNACK(returnCode=0)""
"ts.amp.Server" ->> "ts.amp.Server": ""ts.amp.Server#subscribe(ts.amp.Subscription)""
note right of "ts.amp.Server": Subscribe Client to ""+/+/VendorId/AppId/#""\nOnly start publishing to Client after ""CONNACK"" was sent

...

newpage Identifying Clients

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

note over "ts.amp.Client", "ts.amp.Server": Any incoming request will be followed by an identification check
"ts.amp.Client" -> "ts.amp.Server": ""CONNECT"" /\n""PUBLISH"" / ""PUBACK"" / ""PUBREC"" / ""PUBCOMP"" /\n""SUBSCRIBE"" / ""UNSUBSCRIBE"" /\n""PINGREQ"" /\n""DISCONNECT""
group Identify
	"ts.amp.Server" -> "tradeshift-chrome": Identify ""clientId"" based on ""postMessage"" origin
	"ts.amp.Server" <- - "tradeshift-chrome"
	note right of "ts.amp.Server": If message sender can't be identified or recognized,\nthe message is ignored
end
note over "ts.amp.Server": From now on this step will be shown as follows:
hnote over "ts.amp.Server": Identify Client

...

newpage Keeping Connection Alive

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

loop Within ""keepAlive"" seconds if no other messages are sent
		"ts.amp.Client" ->> "ts.amp.Server": ""PINGREQ""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Client" <<- - "ts.amp.Server": ""PINGRES""
	end

...

newpage Publishing - ""ts.app.publish()""

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

"Tradeshift.MyApp" ->> "ts.app": ""ts.app.publish(ts.app.Message)""
"ts.app" ->> "ts.amp.Client"
alt QoS Level 0
	"ts.amp.Client" ->> "ts.amp.Server": ""PUBLISH("topic", payload, QoS=0)""
	hnote over "ts.amp.Server": Identify Client
else QoS Level 1
	"ts.amp.Client" ->> "ts.amp.Server": ""PUBLISH("topic", payload, QoS=1)""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" ->> "ts.amp.Server": Persist message
	"ts.amp.Client" <<- - "ts.amp.Server": ""PUBACK""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Client" ->> "ts.amp.Client": Delete message
else QoS Level 2
	"ts.amp.Client" ->> "ts.amp.Server": ""PUBLISH("topic", payload, QoS=2)""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" ->> "ts.amp.Server": Persist message
	"ts.amp.Client" <<- - "ts.amp.Server": ""PUBREC""
	"ts.amp.Client" ->> "ts.amp.Server": ""PUBREL""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Client" <<- - "ts.amp.Server": ""PUBCOMP""
	"ts.amp.Client" ->> "ts.amp.Client": Delete message
end
loop For each client subscribed to "topic"
	alt QoS Level 0
		"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("topic", payload, QoS=0)""
	else QoS Level 1
		"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("topic", payload, QoS=1)""
		"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBACK""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Server" ->> "ts.amp.Server": Delete message
	else QoS Level 2
		"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("topic", payload, QoS=2)""
		"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBREC""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBREL"
		"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBCOMP""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Server" ->> "ts.amp.Server": Delete message
	end
end

...

newpage Listening - ""ts.app.listen()""

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

alt QoS Level 0
	"ts.amp.Server" <<- "Other ts.amp.Client": ""PUBLISH("topic", payload, Qos=0)""
	hnote over "ts.amp.Server": Identify Client
else QoS Level 1
	"ts.amp.Server" <<- "Other ts.amp.Client": ""PUBLISH("topic", payload, Qos=1)""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" - ->> "Other ts.amp.Client": ""PUBACK""
	"ts.amp.Server" ->> "ts.amp.Server": Delete message
else QoS Level 2
	"ts.amp.Server" <<- "Other ts.amp.Client": ""PUBLISH("topic", payload, Qos=2)""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" - ->> "Other ts.amp.Client": ""PUBREC""
	"ts.amp.Server" <<- "Other ts.amp.Client": ""PUBREL""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" - ->> "Other ts.amp.Client": ""PUBCOMP""
	"ts.amp.Server" ->> "ts.amp.Server": Delete message
end
loop For each client subscribed to "topic"
	alt QoS Level 0
		"ts.amp.Client" <<- "ts.amp.Server": ""PUBLISH("topic", payload, Qos=0)""
		"ts.app" <<- "ts.amp.Client" : ""ts.app.listen(ts.app.MessageHandler)""
		"Tradeshift.MyApp" <- "ts.app" : ""messageHandler""
	else QoS Level 1
		"ts.amp.Client" <<- "ts.amp.Server": ""PUBLISH("topic", payload, Qos=1)""
		"ts.amp.Client" - ->> "ts.amp.Server": ""PUBACK""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Server" ->> "ts.amp.Server": Delete message
		"ts.app" <<- "ts.amp.Client" : ""ts.app.listen(ts.app.MessageHandler)""
		"Tradeshift.MyApp" <- "ts.app" : ""messageHandler""
	else QoS Level 2
		"ts.amp.Client" <<- "ts.amp.Server": ""PUBLISH("topic", payload, Qos=2)""
		"ts.amp.Client" - ->> "ts.amp.Server": ""PUBREC""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Client" <<- "ts.amp.Server": ""PUBREL""
		"ts.amp.Client" - ->> "ts.amp.Server": ""PUBCOMP""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Server" ->> "ts.amp.Server": Delete message
		"ts.app" <<- "ts.amp.Client" : ""ts.app.listen(ts.app.MessageHandler)""
		"Tradeshift.MyApp" <- "ts.app" : ""messageHandler""
	end
end

...

newpage Subscribing - ""ts.app.subscribe()""

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

"Tradeshift.MyApp" ->> "ts.app": ""ts.app.subscribe(Array<ts.app.Subscription>)""
activate "ts.app"
"ts.app" ->> "ts.amp.Client"
"ts.amp.Client" ->> "ts.amp.Server": ""SUBSCRIBE({"topic0", QoS=0}, {"topic1", QoS=1}, {"topic2", QoS=2}, {"topic3", QoS=1})""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Server" ->> "ts.amp.Server": ""ts.amp.Server.unsubscribe(Array<ts.amp.Subscription>)""
"ts.amp.Client" <<- - "ts.amp.Server": ""SUBACK(0, 1, 2, 128)""
note right of "ts.amp.Server": Server will forward the messages for requested subscription after sending ""SUBACK""\nSee @Receiving
deactivate "ts.app"

...

newpage Unsubscribing - ""ts.app.unsubscribe()""

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

"Tradeshift.MyApp" ->> "ts.app": ""ts.app.unsubscribe(Array<ts.app.Subscription>)""
activate "ts.app"
"ts.app" ->> "ts.amp.Client"
"ts.amp.Client" ->> "ts.amp.Server": ""UNSUBSCRIBE("topic0", "topic1", "topic2)""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Server" ->> "ts.amp.Server": ""ts.amp.Server.subscribe(Array<ts.amp.Subscription>)""
"ts.amp.Client" <<- - "ts.amp.Server": ""UNSUBACK""
note right of "ts.amp.Server": Server will not forward any more messages for this subscription after sending ""UNSUBACK""\nIt does finish sending any messages that were in progress(QoS1, QoS2)
deactivate "ts.app"

...

newpage Exchange - ""ts.app.exchange()"" / Load - ""ts.app.load()""

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

"ts.app" ->> "ts.amp.Client": ""ts.app.exchange(ts.app.Message)""
activate "ts.app"
"ts.amp.Client" ->> "ts.amp.Server": ""SUBSCRIBE("exchange topic", QoS=1, retain=false)""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Server" ->> "ts.amp.Server": ""ts.amp.Server.subscribe(Array<ts.amp.Subscription>)""
"ts.amp.Client" <<- - "ts.amp.Server": ""SUBACK(1)""
"ts.amp.Client" ->> "ts.amp.Server": ""PUBLISH("exchange topic", payload={request}, QoS=1, retain=false)""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Client" <<- - "ts.amp.Server": ""PUBACK""
"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("exchange topic", payload={request}, QoS=1, retain=false)""
"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBACK""
hnote over "ts.amp.Server": Identify Client
alt Success, other app is listening and responding
	"ts.amp.Server" <<- "Other ts.amp.Client": ""PUBLISH("exchange topic", payload={loading: true}, QoS=1, retain=false)""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" - ->> "Other ts.amp.Client": ""PUBACK""
	loop While we're waiting for user interaction to finish
		"ts.amp.Server" <<- "Other ts.amp.Client": ""PINGREQ""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Server" - ->> "Other ts.amp.Client": ""PINGRES""
		"ts.amp.Client" ->> "ts.amp.Server": ""PINGREQ""
		hnote over "ts.amp.Server": Identify Client
		"ts.amp.Client" <<- - "ts.amp.Server": ""PINGRES""
	end
	"ts.amp.Server" <<- "Other ts.amp.Client": ""PUBLISH("exchange topic", payload={response}, QoS=1, retain=false)""
	hnote over "ts.amp.Server": Identify Client
	"ts.amp.Server" - ->> "Other ts.amp.Client": ""PUBACK""
	"ts.amp.Client" <<- "ts.amp.Server": ""PUBLISH("exchange topic", payload={response}, QoS=1, retain=false)""
	"ts.amp.Client" - ->> "ts.amp.Server": ""PUBACK""
	hnote over "ts.amp.Server": Identify Client
else Failure, other app is not listening or responding
	note over "ts.amp.Server":No meaningful response from other app within ""keepAlive"" seconds
	"ts.amp.Client" <<- "ts.amp.Server": ""PUBLISH("exchange topic", payload={err}, QoS=1, retain=false)""
	"ts.amp.Client" - ->> "ts.amp.Server": ""PUBACK""
	hnote over "ts.amp.Server": Identify Client
end
deactivate "ts.app"
"ts.amp.Client" ->> "ts.amp.Server": ""UNSUBSCRIBE("exchange topic")""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Server" ->> "ts.amp.Server": ""ts.amp.Server.unsubscribe(Array<ts.amp.Subscription>)""
"ts.amp.Client" <<- - "ts.amp.Server": ""UNSUBACK""

...

newpage Unexpected disconnect

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		Group {
			FontSize 12
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...
note over "ts.amp.Client": No messages sent for ""keepAlive"" seconds
"ts.amp.Server" -> "ts.amp.Server": ts.amp.Server.unsubscribe()
note right of "ts.amp.Server": Unsubscribe Client from all of its subscriptions

opt If ""ts.amp.Client"" has a ""will"" defined
	loop For each client subscribed to "will topic"
		alt QoS Level 0
			"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("will topic", payload, QoS=0)""
		else QoS Level 1
			"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("will topic", payload, QoS=1)""
			"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBACK""
			hnote over "ts.amp.Server": Identify Client
			"ts.amp.Server" ->> "ts.amp.Server": Delete message
		else QoS Level 2
			"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBLISH("will topic", payload, QoS=2)""
			"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBREC""
			hnote over "ts.amp.Server": Identify Client
			"ts.amp.Server" ->> "Other ts.amp.Client": ""PUBREL"
			"ts.amp.Server" <<- - "Other ts.amp.Client": ""PUBCOMP""
			hnote over "ts.amp.Server": Identify Client
			"ts.amp.Server" ->> "ts.amp.Server": Delete message
		end
	end
end

...

newpage Disconnecting - ""ts.app.disconnect()""

skinparam {
	DefaultFontName Open Sans
	Padding 5
	BoxPadding 10
	Note {
		BackgroundColor #E8F6FF
		FontColor #1F2D3D
		BorderColor #224F6B
	}

	sequence {
		BoxBorderColor #9DB4C0
		Group {
			BackgroundColor #EAFFFF
			BodyBackgroundColor #F4FFFF
			BorderColor #9DB4C0
			BorderThickness 1
		}

		Arrow {
			Color #253237
			Thickness 2
		}

		LifeLine {
			BorderColor #5C6B73
		}

		Participant {
			BorderColor #5C6B73
			BackgroundColor #5C6B73
			FontColor #FFFFFF
		}

	}
}

box "Tradeshift.MyApp iframe" #E0FBFC
	participant "Tradeshift.MyApp"
	participant "ts.app"
	participant "ts.amp.Client"
end box
box "tradeshift-chrome topframe" #C2DFE3
	participant "ts.amp.Server"
	participant "tradeshift-chrome"
end box
box "Other.App iframe" #9DB4C0
	participant "Other ts.amp.Client"
end box

...

[-> "ts.app": ts.app.disconnect()
"ts.app" -> "ts.amp.Client"
"ts.amp.Client" -> "ts.amp.Server": ""DISCONNECT""
hnote over "ts.amp.Server": Identify Client
"ts.amp.Server" -> "ts.amp.Server": ts.amp.Server.unsubscribe()
note right of "ts.amp.Server": Unsubscribe Client from all of its subscriptions

@enduml

PlantUML version 1.2017.15(Mon Jul 03 18:45:34 CEST 2017)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1024-b8
Operating System: Mac OS X
OS Version: 10.13.2
Default Encoding: UTF-8
Language: en
Country: DK
--></g></svg>