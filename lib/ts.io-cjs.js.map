{"version":3,"file":"ts.io-cjs.js","sources":["../src/log.js","../src/msg.js","../src/app.js","../src/lib.js","../src/hub.js","../src/idx.js"],"sourcesContent":["const colors = [\n\t// Red\n\t// 'hsl(0, 57%, 90%)',\n\t// 'hsl(0, 59%, 80%)',\n\t// 'hsl(0, 59%, 60%)',\n\t// 'hsl(0, 100%, 37%)',\n\t// 'hsl(0, 100%, 30%)',\n\t// 'hsl(0, 100%, 24%)',\n\n\t// Orange\n\t'hsl(32, 100%, 92%)',\n\t'hsl(33, 100%, 84%)',\n\t'hsl(33, 100%, 68%)',\n\t'hsl(33, 100%, 50%)',\n\t'hsl(31, 100%, 47%)',\n\t'hsl(26, 100%, 41%)',\n\n\t// Yellow\n\t'hsl(44, 95%, 92%)',\n\t'hsl(45, 95%, 85%)',\n\t'hsl(44, 96%, 70%)',\n\t'hsl(44, 98%, 53%)',\n\t'hsl(40, 100%, 52%)',\n\t'hsl(34, 100%, 49%)',\n\n\t// Green\n\t'hsl(99, 59%, 90%)',\n\t'hsl(99, 60%, 81%)',\n\t'hsl(99, 61%, 63%)',\n\t'hsl(99, 85%, 42%)',\n\t'hsl(101, 87%, 33%)',\n\t'hsl(103, 91%, 26%)',\n\n\t// Blue\n\t'hsl(199, 100%, 92%)',\n\t'hsl(199, 100%, 84%)',\n\t'hsl(199, 100%, 68%)',\n\t'hsl(199, 100%, 50%)',\n\t'hsl(201, 100%, 40%)',\n\t'hsl(203, 100%, 32%)',\n\n\t// Purple\n\t'hsl(295, 39%, 89%)',\n\t'hsl(295, 40%, 78%)',\n\t'hsl(295, 40%, 57%)',\n\t'hsl(295, 79%, 34%)',\n\t'hsl(294, 82%, 26%)',\n\t'hsl(296, 100%, 19%)',\n\n\t// Pink\n\t'hsl(325, 46%, 89%)',\n\t'hsl(325, 48%, 78%)',\n\t'hsl(325, 48%, 57%)',\n\t'hsl(325, 98%, 33%)',\n\t'hsl(327, 99%, 26%)',\n\t'hsl(329, 100%, 21%)'\n];\n\nfunction debugEnabled(namespace) {\n\tlet debugExpression;\n\ttry {\n\t\tdebugExpression = window.localStorage.getItem('debug');\n\t} catch (error) {\n\t\tif (\n\t\t\terror instanceof DOMException &&\n\t\t\t(error.name === 'DataCloneError' ||\n\t\t\t\terror.code === 25) /* DATA_CLONE_ERR */\n\t\t) {\n\t\t\tconsole.warn(\n\t\t\t\t'ts.io error while setting up debug logging. You should ignore this message or set %o while sandboxing your iframe. %O',\n\t\t\t\t'allow-same-origin',\n\t\t\t\terror\n\t\t\t);\n\t\t} else {\n\t\t\tconsole.warn('ts.io error while setting up debug logging.', error);\n\t\t}\n\t}\n\t// No expression, no logging.\n\tif (!debugExpression) {\n\t\treturn false;\n\t}\n\tconst debugExpressionLength = debugExpression.length;\n\t// If the namespace is shorter than the expression, it definitely won't match.\n\tif (namespace.length < debugExpressionLength) {\n\t\treturn false;\n\t}\n\t// '*' => Log everything.\n\tif (debugExpression === '*') {\n\t\treturn true;\n\t}\n\tlet shouldEnable = false;\n\tfor (let i = 0; i < debugExpressionLength; i++) {\n\t\tconst debugExpressionChar = debugExpression[i];\n\t\tconst matchNamespace = debugExpressionChar === namespace[i];\n\t\tconst atLastChar = i === debugExpressionLength - 1;\n\t\tif (matchNamespace || (atLastChar && debugExpressionChar === '*')) {\n\t\t\tshouldEnable = true;\n\t\t\tcontinue;\n\t\t} else {\n\t\t\tshouldEnable = false;\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn shouldEnable;\n}\n\n/**\n * Console debug logger.\n */\nclass Log {\n\t/**\n\t * @constructor\n\t * @param {string} namespace Namespace\n\t * @param {string} color Color\n\t */\n\tconstructor(namespace, color) {\n\t\tthis.namespace = namespace;\n\t\tthis.color = color;\n\t\tthis.previousTime = 0;\n\t\t/**\n\t\t * @param {string=} message Message\n\t\t * @param {any[]} optionalParams Optional Params\n\t\t */\n\t\tthis.log = (message, ...optionalParams) => {\n\t\t\tconst now = window.performance.now();\n\t\t\tconst deltaTime = now - (this.previousTime || now);\n\t\t\tthis.previousTime = now;\n\t\t\tconsole.log(\n\t\t\t\t`%c${this.namespace}%c - ${message} - %c${parseFloat(deltaTime).toFixed(\n\t\t\t\t\t2\n\t\t\t\t)}ms`,\n\t\t\t\t`color: ${this.color};`,\n\t\t\t\t'font-weight: normal;',\n\t\t\t\t...optionalParams,\n\t\t\t\t`color: ${this.color};`\n\t\t\t);\n\t\t};\n\t}\n}\n\n/**\n * Generate a debug logger.\n * @param {string} namespace Namespace\n * @return {Function}\n */\nexport function log(namespace) {\n\tif (!debugEnabled(namespace)) {\n\t\treturn function() {};\n\t}\n\n\tlet hash = 0;\n\tconst namespaceLength = namespace.length;\n\tfor (let i = 0; i < namespaceLength; i++) {\n\t\thash = (hash << 5) - hash + namespace.charCodeAt(i);\n\t\thash |= 0; // Convert to 32bit integer\n\t}\n\n\tconst color = colors[Math.abs(hash) % colors.length];\n\tconst debug = new Log(namespace, color);\n\treturn debug.log;\n}\n","/**\n * The Message.\n * @typedef {object} Message\n * @property {string} type The type of the message. (one of ['CONNECT', 'CONNACK', 'PUBLISH', 'PINGREQ', 'PINGRES'])\n * @property {string=} topic The topic of the message. (required for 'PUBLISH' type)\n * @property {string=} target Target appId. (required for ['PUBLISH', 'CONNACK', 'PINGREQ'] types)\n * @property {boolean} viaHub The message was brokered by the Hub.\n * @property {string=} token Hack-proof session token. (required for all types except 'CONNECT')\n * @property {*=} data Data to be passed with the message. Can be any type that is compatible with the structured clone algorithm,\n */\n\n/**\n * Send message to target window.\n * @param {Message} message\n * @param {Window=} targetWindow\n */\nexport function postMessage(message, targetWindow) {\n\tif (!targetWindow) {\n\t\ttargetWindow = window.top;\n\t}\n\ttry {\n\t\ttargetWindow.postMessage(message, '*');\n\t} catch (error) {\n\t\tif (\n\t\t\terror instanceof DOMException &&\n\t\t\t(error.name === 'DataCloneError' ||\n\t\t\t\terror.code === 25) /* DATA_CLONE_ERR */\n\t\t) {\n\t\t\tthrow new Error(\n\t\t\t\t\"ts.io.publish called with { data } argument that can't be cloned using the structural clone algorithm.\"\n\t\t\t);\n\t\t} else {\n\t\t\tconsole.warn('Something went wrong while sending postMessage.', error);\n\t\t}\n\t}\n}\n\n/**\n * Validate message.\n * @param {Message} message\n */\nexport function messageValid(message) {\n\treturn message && message.type;\n}\n\n/**\n * Validate message for 'PUBLISH' type.\n * @param {Message} message\n */\nexport function publishMessageValid(message) {\n\treturn (\n\t\tmessageValid(message) &&\n\t\tmessage.type === 'PUBLISH' &&\n\t\tmessage.topic &&\n\t\tmessage.target\n\t);\n}\n\n/**\n * Message is sent to an App.\n * @param {Message} message\n */\nexport function appMessageValid(message) {\n\treturn (\n\t\tmessageValid(message) &&\n\t\tmessage.viaHub &&\n\t\t['CONNACK', 'PUBLISH', 'PING'].includes(message.type)\n\t);\n}\n\n/**\n * Message sent to the Hub.\n * @param {Message} message\n */\nexport function hubMessageValid(message) {\n\treturn (\n\t\tmessageValid(message) &&\n\t\t!message.viaHub &&\n\t\t['CONNECT', 'PUBLISH', 'PONG'].includes(message.type)\n\t);\n}\n\n/**\n * Does the topic match the expression?\n *\n * @todo Support more than '*' or exact match.\n *\n * @param {string} topicExpression Topic expression to match.\n * @param {string} topic Topic to match.\n */\nexport function matchTopic(topicExpression, topic) {\n\tif (topicExpression === '*') {\n\t\treturn true;\n\t}\n\treturn topicExpression === topic;\n}\n","import { log } from './log';\nimport { postMessage, matchTopic, appMessageValid } from './msg';\n\n/**\n * The Message Client AKA The App.\n */\nexport function app() {\n\tlet debug = log('ts:io:sub');\n\n\tlet appId = '';\n\tlet token = '';\n\n\t/**\n\t * Set of `on()` handlers keyed by `topic`\n\t * @type {Map<topic: string, handlers: Set<Function>>}\n\t */\n\tconst handlersByTopic = new Map();\n\n\tconst api = {\n\t\t/**\n\t\t * Handle messages.\n\t\t * @returns {Function} Deregistrator of listener.\n\t\t */\n\t\ton: function() {\n\t\t\t/**\n\t\t\t * Specific topic that we will call the handler for.\n\t\t\t * @type {string|undefined}\n\t\t\t */\n\t\t\tlet topic = '*';\n\t\t\t/**\n\t\t\t * Handler of the message.\n\t\t\t * @type {function}\n\t\t\t */\n\t\t\tlet handler = function() {};\n\n\t\t\tif (arguments.length === 1 && typeof arguments[0] === 'function') {\n\t\t\t\t/**\n\t\t\t\t * Single argument - handler.\n\t\t\t\t */\n\t\t\t\thandler = arguments[0];\n\t\t\t} else if (\n\t\t\t\targuments.length === 2 &&\n\t\t\t\ttypeof arguments[0] === 'string' &&\n\t\t\t\ttypeof arguments[1] === 'function'\n\t\t\t) {\n\t\t\t\t/**\n\t\t\t\t * Two arguments - topic and handler.\n\t\t\t\t */\n\t\t\t\ttopic = arguments[0];\n\t\t\t\thandler = arguments[1];\n\t\t\t} else {\n\t\t\t\tthrow new Error('ts.app.on called with invalid arguments.', arguments);\n\t\t\t}\n\n\t\t\tif (handlersByTopic.has(topic)) {\n\t\t\t\thandlersByTopic.get(topic).add(handler);\n\t\t\t} else {\n\t\t\t\thandlersByTopic.set(topic, new Set([handler]));\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Return the deregistrator.\n\t\t\t */\n\t\t\treturn () => {\n\t\t\t\tconst handlers = handlersByTopic.get(topic);\n\t\t\t\tif (handlers) {\n\t\t\t\t\thandlers.delete(handler);\n\t\t\t\t}\n\t\t\t\tdebug(\n\t\t\t\t\t'%s handler %o - %O',\n\t\t\t\t\thandlers ? 'Deleted' : \"Didn't find\",\n\t\t\t\t\ttopic,\n\t\t\t\t\thandler\n\t\t\t\t);\n\t\t\t\treturn this;\n\t\t\t};\n\t\t},\n\t\t/**\n\t\t * Publish message..\n\t\t * @alias publish\n\t\t * @returns {Object} Chainable\n\t\t */\n\t\tpublish: function() {\n\t\t\t/**\n\t\t\t * Target appId.\n\t\t\t * No wildcards supported.\n\t\t\t * @type {string}\n\t\t\t */\n\t\t\tlet target = '';\n\t\t\t/**\n\t\t\t * Topic.\n\t\t\t * @optional\n\t\t\t * @type {string}\n\t\t\t */\n\t\t\tlet topic = '';\n\t\t\t/**\n\t\t\t * Data.\n\t\t\t * @optional\n\t\t\t * @type {*}\n\t\t\t */\n\t\t\tlet data = {};\n\n\t\t\tif (arguments.length === 1 && typeof arguments[0] === 'object') {\n\t\t\t\t/**\n\t\t\t\t * Single argument - {target, topic, data}\n\t\t\t\t */\n\t\t\t\ttarget = arguments[0].target;\n\t\t\t\ttopic = arguments[0].topic;\n\t\t\t\tdata = arguments[0].data;\n\t\t\t} else if (\n\t\t\t\targuments.length >= 2 &&\n\t\t\t\ttypeof arguments[0] === 'string' &&\n\t\t\t\ttypeof arguments[1] === 'string'\n\t\t\t) {\n\t\t\t\t/**\n\t\t\t\t * Two arguments - target, topic\n\t\t\t\t */\n\t\t\t\ttarget = arguments[0];\n\t\t\t\ttopic = arguments[1];\n\t\t\t\tif (arguments.length === 3) {\n\t\t\t\t\t/**\n\t\t\t\t\t * Three arguments - target, topic, data\n\t\t\t\t\t */\n\t\t\t\t\tdata = arguments[2];\n\t\t\t\t}\n\t\t\t}\n\t\t\tdebug('%o (%o) to %o - %o', 'PUBLISH', topic, target, data);\n\t\t\tpostMessage({ type: 'PUBLISH', target, topic, data, token });\n\t\t\treturn this;\n\t\t},\n\t\t/**\n\t\t * Request a response.\n\t\t * @returns {Promise}\n\t\t */\n\t\trequest: function() {},\n\t\t/**\n\t\t * Spawn an app...\n\t\t * @alias spawn\n\t\t * @returns {Promise}\n\t\t */\n\t\tspawn: function() {},\n\t\t/**\n\t\t * Open an app..\n\t\t * @alias open\n\t\t * @returns {Promise}\n\t\t */\n\t\topen: function() {}\n\t};\n\n\t/**\n\t * Handle events this app is listening for.\n\t * @param {MessageEvent} event\n\t */\n\tfunction eventHandler(event) {\n\t\tconst message = event.data;\n\t\t// Only accept messages from the hub in window.top.\n\t\tif (event.source !== window.top || !appMessageValid(message)) {\n\t\t\treturn;\n\t\t}\n\t\t// The hub.top will get its own messages back, they will be ignored.\n\t\tif (message.target && appId && message.target !== appId) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (message.type === 'CONNACK') {\n\t\t\tappId = message.target || '';\n\t\t\ttoken = message.token || '';\n\t\t\tdebug = log('ts:io:sub:' + appId);\n\t\t\tdebug('CONNECTED');\n\n\t\t\treturn;\n\t\t}\n\n\t\t// Call the matching handlers for the message topic.\n\t\tswitch (message.type) {\n\t\t\tcase 'PUBLISH':\n\t\t\t\tdebug(\n\t\t\t\t\t'%o (%o) from %o - %O',\n\t\t\t\t\tmessage.type,\n\t\t\t\t\tmessage.topic,\n\t\t\t\t\tmessage.source,\n\t\t\t\t\tmessage\n\t\t\t\t);\n\t\t\t\thandlersByTopic.forEach(\n\t\t\t\t\t(handlers, topic) =>\n\t\t\t\t\t\tmatchTopic(topic, message.topic) &&\n\t\t\t\t\t\thandlers.forEach(handler => handler(message))\n\t\t\t\t);\n\t\t\t\tbreak;\n\t\t\tcase 'PING':\n\t\t\t\tpostMessage({ type: 'PONG', token });\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\t/**\n\t * Start listening to messages from window.top.\n\t */\n\twindow.addEventListener('message', eventHandler);\n\n\t/**\n\t * Send CONNECT to Hub.\n\t */\n\tdebug('Connecting…');\n\tpostMessage({ type: 'CONNECT' });\n\n\treturn api;\n}\n","/**\n * Are we in the same frame as the Tradeshift® Chrome™?\n * @return {boolean}\n */\nexport function isChromeWindow() {\n\treturn window.ts && window.ts.chrome !== undefined;\n}\n\n/**\n * Heartbeat regularity in ms.\n * @type {number}\n */\nexport const HEARTBEAT = 5000;\n","import uuid from 'uuid';\nimport { log } from './log';\nimport { app } from './app';\nimport { postMessage, hubMessageValid, publishMessageValid } from './msg';\nimport { HEARTBEAT } from './lib';\n\n/**\n * Special features supplied by the Tradeshift® Chrome™.\n * @typedef {object} ChromeWindowFeatures\n * @property {function(Window): string} appIdByWindow Called to get an appId based on a Window object.\n * @property {function(string, Window): Window} windowByAppId Called to get a window object based on an appId and the requesting app's Window object.\n * @property {function(Window): void} appTimeout Called when an app fails to reply in time to a PING request.\n */\n\n/**\n * The Message Broker AKA The Hub.\n * @param {ChromeWindowFeatures} chrome Special features supplied by the Tradeshift® Chrome™\n */\nexport function hub(chrome) {\n\tconst debug = log('ts:io:top');\n\t/**\n\t * WeakMap of frames with apps.\n\t * @type {WeakMap<Window, Object<appId: string, token: string>}\n\t */\n\tconst appWindows = new WeakMap();\n\t/**\n\t * Map of when the last PONG, or any other message was sent from an app.\n\t * @type {Map<token: string, Object<lastPong: DOMHighResTimeStamp, timeoutIds: Set<timeoutId: number>}\n\t */\n\tconst appPongs = new Map();\n\n\t/*\n\t1. after sending CONNACK to an app, PING it after HEARTBEAT ms\n\t2. if it replies, wait HEARTBEAT ms and PING again, - repeat forever\n\t3. if it doesn't reply within 4 * HEARTBEAT ms, consider the client dead and remove it from the list while removing all traces of it\n\t*/\n\tfunction pingApp(opts) {\n\t\tconst { appId, token, targetWindow } = opts;\n\n\t\tconst now = window.performance.now();\n\t\tconst appPongInfo = appPongs.get(token);\n\t\tconst lastPong = (appPongInfo && appPongInfo.lastPong) || now;\n\t\tif (now - lastPong < 3 * HEARTBEAT) {\n\t\t\tappPongInfo.timeoutIds.add(setTimeout(() => pingApp(opts), HEARTBEAT));\n\t\t\tpostMessage(\n\t\t\t\t{ type: 'PING', viaHub: true, target: appId, token },\n\t\t\t\ttargetWindow\n\t\t\t);\n\t\t} else {\n\t\t\tdebug('App timed out, considering it dead! %o', appId);\n\t\t\ttry {\n\t\t\t\tchrome.appTimeout(targetWindow);\n\t\t\t\tappWindows.delete(targetWindow);\n\t\t\t\tappPongInfo.timeoutIds.forEach(timeoutId => clearTimeout(timeoutId));\n\t\t\t\tappPongs.delete(token);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(error);\n\t\t\t}\n\t\t}\n\t}\n\n\twindow.addEventListener('message', function(event) {\n\t\tconst message = event.data;\n\n\t\t// Only accept valid messages from apps.\n\t\tif (!hubMessageValid(message)) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Message from a frame we don't know yet.\n\t\tif (!appWindows.has(event.source)) {\n\t\t\t// The only command should be CONNECT, we fail otherwise.\n\t\t\tif (message.type === 'CONNECT') {\n\t\t\t\tconst appId = chrome.appIdByWindow(event.source);\n\t\t\t\tconst token = uuid();\n\t\t\t\tdebug('CONNECT %o', appId);\n\t\t\t\tappWindows.set(event.source, { appId, token });\n\t\t\t\tpostMessage(\n\t\t\t\t\t{ type: 'CONNACK', viaHub: true, target: appId, token },\n\t\t\t\t\tevent.source\n\t\t\t\t);\n\t\t\t\tconst pingOpts = { targetWindow: event.source, appId, token };\n\t\t\t\tconst timeoutId = setTimeout(() => pingApp(pingOpts), HEARTBEAT);\n\t\t\t\tappPongs.set(token, {\n\t\t\t\t\tlastPong: window.performance.now(),\n\t\t\t\t\ttimeoutIds: new Set([timeoutId])\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t} else {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t'Unexpected critical error! ts.app sent message without being connected!',\n\t\t\t\t\tevent\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif (message.token !== appWindows.get(event.source).token) {\n\t\t\tconsole.warn(\n\t\t\t\t'Token seems invalid, discarding message!\\n' +\n\t\t\t\t\tJSON.stringify(message, null, 2)\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tconst appWindow = appWindows.get(event.source);\n\t\tconst token = (message.token = appWindow.token);\n\t\tmessage.source = appWindow.appId;\n\t\tmessage.viaHub = true;\n\n\t\tif (message.source === message.target) {\n\t\t\tconsole.warn(\n\t\t\t\t'Source and destination match, discarding message!\\n' +\n\t\t\t\t\tJSON.stringify(message, null, 2)\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tswitch (message.type) {\n\t\t\tcase 'PUBLISH':\n\t\t\t\tif (!publishMessageValid(message)) {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t'Message incomplete for a PUBLISH command!\\n' +\n\t\t\t\t\t\t\tJSON.stringify(message)\n\t\t\t\t\t);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t/**\n\t\t\t\t * @TODO Handle the case when the Chrome blocks certain targets for certain sources\n\t\t\t\t */\n\t\t\t\tconst targetWindow = chrome.windowByAppId(message.target, event.source);\n\t\t\t\tdebug(\n\t\t\t\t\t'Routing %o from %o to %o - %O',\n\t\t\t\t\t'PUBLISH',\n\t\t\t\t\tmessage.source,\n\t\t\t\t\tmessage.target,\n\t\t\t\t\tmessage\n\t\t\t\t);\n\t\t\t\tpostMessage(message, targetWindow);\n\t\t\t\tbreak;\n\t\t\tcase 'PONG':\n\t\t\t\tappPongs.set(token, {\n\t\t\t\t\t...appPongs.get(token),\n\t\t\t\t\tlastPong: window.performance.now()\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tdebug('* %o', event.data);\n\t\t\t\tbreak;\n\t\t}\n\t});\n\n\treturn {\n\t\ttop: app\n\t};\n}\n","import { app } from './app';\nimport { hub } from './hub';\nimport { isChromeWindow } from './lib';\n\nconst api = isChromeWindow() ? hub : app;\n\nexport default api;\n"],"names":[],"mappings":"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"}